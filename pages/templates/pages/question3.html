<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <title>Question 1</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'question.css' %}">
    <link rel="stylesheet" href="{% static 'navbar.css' %}">
  </head>
  <body>
    {% include 'partials/navbar.html' %}
    <div class="container">
      <div class="context-box">
        <div id="enonce">
        <h1 class="titre-principal">Nous avons rÃ©ussi Ã  intercepter trois messages entre les malfrats ! Chacun dâ€™entre vous doit en dÃ©coder un pour dÃ©couvrir les trois monuments en danger !</h1>
        <h2>Vous devez remettre les lettres dans le bon ordre et reformer la phrase pour trouver l'indice qui vous mÃ¨nera vers un monument</h2>
            {% if joueur_id == 1 %}
                <div>
                    ste panoJ ua pÃªtre L'lalationtins
                </div>
            {% elif joueur_id == 2 %}
                <div>
                    ne GerÃ¨c ste Tuos rÃªpt assui
                </div>
            {% elif joueur_id == 3 %}
                <div>
                    venis eJ sRisue ifnir ne ed
                </div>
            {% endif %}

        <div class="reponse-box">
            <input type="text" id="reponse" name="reponse" placeholder="Ta rÃ©ponse ici...">
            <button id="submit-reponse" class="btn-valider">Valider</button>
        </div>
        <p>(Format rÃ©ponse attendu : le noms des trois monuments visÃ©s)</p>
    </div>
    </div>
        
    <!-- Message de fÃ©licitations -->
    <div id="felicitation" style="display:none; text-align:center; margin-top:30px;">
        <h2 style="color:#00ff99; text-shadow:0 0 10px #00ff99;">ğŸ‰ Bravo, mission accomplie !</h2>
    </div>

    <!-- Message d'indice -->
    <div id="indice-suivant" style="display:none; text-align:center; margin-top:20px;">
        <p style="color:#ff4081; font-size:1.2em;">
            Indice supplÃ©mentaire : Le monument est visible depuis une grande baie...
        </p>
    </div>

                <div id="popup-attaque" class="popup" style="display:none;">
                    <div class="popup-content">
                        <p>Nous avons enfin assez d'indices pour localiser la planque des malfrats</p>
                        <button id="close-attaque">Fermer</button>
                    </div>
                </div>


                <div class="erreur" style="display:none; color:red;">
                    <p>Mauvaise rÃ©ponse âŒ â€” essaye encore !</p>
                </div>

        <div class="resultat" style="display:none;">ğŸ‰ Bravo, tu as rÃ©ussi !</div>
        <div class="erreur" style="display:none;">âŒ Mauvaise rÃ©ponse, rÃ©essaie !</div>
      </div>

      <button class="bouton-aide">ğŸ’¡</button>

      <div id="popup-indice" class="popup" style="display:none;">
        <div class="popup-content">
          <span id="close-popup">&times;</span>
          <p>Vous possÃ©dez un seul indice pour toute la partie, voulez vous vraiment l'utiliser</p>
          <button id="confirm-indice" class="btn-oui">Oui</button>
          <button id="cancel-indice" class="btn-non">Non</button>
        </div>
      </div>
      <div class="indice" style="display:none;">
        {% if joueur_id == 1 %}
            <p>L'installation est prÃªte</p>
        {% elif joueur_id == 2 %}
            <p>Tous est prÃªt aussi</p>
        {% elif joueur_id == 3 %}
            <p>Je viens de finir</p>
        {% endif %}
      </div>
    </div>

<script>
const helpBtn = document.querySelector('.bouton-aide');
const popup = document.getElementById('popup-indice');
const closePopup = document.getElementById('close-popup');
const confirmBtn = document.getElementById('confirm-indice');
const cancelBtn = document.getElementById('cancel-indice');
const indice = document.querySelector('.indice');

const submitBtn = document.getElementById('submit-reponse');
const reponse = document.getElementById('reponse');
const resultat = document.querySelector('.resultat');
const erreur = document.querySelector('.erreur');
const reponseBox = document.querySelector('.reponse-box');
const popupAttaque = document.getElementById('popup-attaque');
const closeAttaque = document.getElementById('close-attaque');

let joueurId = localStorage.getItem('joueurId') || '{{ joueur_id }}';
let questionActuelle = localStorage.getItem('questionActuelle') || 1;
let indiceUtilise = localStorage.getItem('indiceUtilise') === 'true';

// Verification de la question et de l'utilisation de l'indice
const urlMatch = window.location.pathname.match(/question(\d+)\/\d+\//);
if (urlMatch) {
    const currentQuestion = parseInt(urlMatch[1]);
    if (currentQuestion !== parseInt(questionActuelle)) {
        window.location.href = `/question${questionActuelle}/${joueurId}/`;
    }
}

// EmpÃªche lâ€™usage multiple de lâ€™indice
if (indiceUtilise) {
    helpBtn.disabled = true;
    helpBtn.style.opacity = 0.5;
    indice.style.display = 'none';
}

helpBtn.addEventListener('click', () => {
    popup.style.display = 'flex';
});

closePopup.addEventListener('click', () => popup.style.display = 'none');
cancelBtn.addEventListener('click', () => popup.style.display = 'none');

confirmBtn.addEventListener('click', () => {
    indice.style.display = 'block';
    helpBtn.disabled = true;
    helpBtn.style.opacity = 0.5;
    popup.style.display = 'none';
    reponseBox.style.display = 'block';
    localStorage.setItem('indiceUtilise', true);//ChÃ¢teau d'Osaka CathÃ©drale Lâ€™Acropole dâ€™AthÃ¨nes Basile-le-Bienheureux
});

submitBtn.addEventListener('click', () => {
    let valeur = reponse.value
        .toLowerCase()
        .normalize('NFD') // retire les accents
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/['â€™]/g, '') // retire les apostrophes
        .trim();

    const monumentsAttendus = [
        "chateau dosaka",
        "cathedrale lacropole dathenes",
        "basile-le-bienheureux"
    ];

    // VÃ©rifie si chaque monument est prÃ©sent dans la rÃ©ponse (peu importe lâ€™ordre)
    const tousTrouves = monumentsAttendus.every(m => valeur.includes(m));

    if (tousTrouves) {
        // Bonne rÃ©ponse
        document.getElementById('enonce').style.display = 'none';
        reponseBox.style.display = 'none';
        erreur.style.display = 'none';
        document.getElementById('felicitation').style.display = 'block';

        const felicitation = document.getElementById('felicitation');
        const indiceSuivant = document.getElementById('indice-suivant');
        felicitation.style.display = 'block';

        questionActuelle = parseInt(questionActuelle) + 1;
        localStorage.setItem('questionActuelle', questionActuelle);

        setTimeout(() => {
            popupAttaque.style.display = 'flex';
        }, 4000);
    } else {
        erreur.style.display = 'block';
    }
});
// --- FERMETURE DU POPUP Dâ€™ATTAQUE ---
closeAttaque.addEventListener('click', () => {
    popupAttaque.style.display = 'none';
    window.location.href = `/epreuve/${joueurId}/`; // redirige vers la question suivante
});
</script>
</body>
</html>