<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <title>Enigme 1</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'question.css' %}">
    <link rel="stylesheet" href="{% static 'navbar.css' %}">
    <style>
      .timer {
        position: absolute; /* sous la navbar */
        top: 70px; /* ajuster selon la hauteur de la navbar */
        right: 30px;
        font-size: 36px;
        font-weight: 900;
        color: #ff0000;
        z-index: 9999;
        font-family: "Poppins", sans-serif;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
      }
    </style>
  </head>
  <body>
    {% include 'partials/navbar.html' %}

    <div class="timer" id="timer">05:00</div>

    <div class="container">
        <div class="context-box">
            <div class="context-box" id="enonce">
                <h1 class="titre-principal">Ensemble trouvez le monument vis√©, la date et l'heure de l'attaque dans le temps imparti !</h1>
                {% if joueur_id == 1 %}
                    <h2>R√©sous le calcul pour obtenir la date de construction du monument que l'on recherche!</h2>
                    <div class="calcul">
                        Ann√©e de construction de la Cath√©drale Saint-Paul + Taille de la tour Eiffel en m√®tres + Nombre d'habitants √† Moscou en millions - 2
                    </div>
                {% elif joueur_id == 2 %}
                    <h2>R√©sous le calcul pour obtenir la date pr√©vue de l'attaque!</h2>
                    <div class="calcul">
                        <p>Jour = Nombre de pays diff√©rent dans la documentation - Nombre d'habitant √† Ath√®nes en million</p>    
                        <p>Mois = Nombre d'habitant en million de Londres - Nombre d'habitant en million de Paris </p>
                    </div>
                {% elif joueur_id == 3 %}
                    <h2>R√©sous le calcul pour obtenir l'heure pr√©vue de l'attaque!</h2>
                    <div class="calcul">
                        Poids de la Tour Eiffel - Altitude du pont Cau Vang -
                        <div class="fraction">
                            <span class="num">Habitants de Chiang Rai</span>
                            <span class="den">10</span>
                        </div>
                        - 100
                    </div>
                {% endif %}
            </div>

            <!-- Message de f√©licitations -->
            <div id="felicitation" style="display:none; text-align:center; margin-top:30px;">
                <h2 style="color:#00ff99; text-shadow:0 0 10px #00ff99;">Vos informations √©taient bonnes, nous avons pu d√©jouer l'attaque !</h2>
            </div>

            <!-- Message d'indice -->
            <div id="indice-suivant" style="display:none; text-align:center; margin-top:20px;">
                <h2>
                    Nous avons re√ßu une information : 70 000.<br>
                    Elle nous aidera s√ªrement √† localiser la planque des malfrats plus tard !
                </h2>
            </div>

            <div class="reponse-box">
                <input type="text" id="reponse" name="reponse" placeholder="Ta r√©ponse ici...">
                <button id="submit-reponse" class="btn-valider">Valider</button>
            </div>
            <p id="format-reponse">(Format r√©ponse attendu : Nom monument JJ/MM 00:00)</p>

                    <div class="resultat" style="display:none">
                        <p>
                            Bravo !</br>
                            Tu as trouv√© la bonne r√©ponse. üéâ</br>
                        </p>
                    </div>

                    <div id="popup-attaque" class="popup" style="display:none;">
                        <div class="popup-content">
                            <p>On a re√ßu d'autres informations sur une attaque potentielle !</p>
                            <button id="close-attaque">Y allez</button>
                        </div>
                    </div>


                    <div class="erreur" style="display:none; color:red;">
                        <p>Mauvaise r√©ponse ‚ùå ‚Äî essaye encore !</p>
                    </div>
        </div>

        <button class="bouton-aide">üí°</button>

      <div id="popup-indice" class="popup" style="display:none;">
        <div class="popup-content">
          <span id="close-popup">&times;</span>
          <p>Vous poss√©dez un seul indice pour toute la partie, voulez vous vraiment l'utiliser ?</p>
          <button id="confirm-indice" class="btn-oui">Oui</button>
          <button id="cancel-indice" class="btn-non">Non</button>
        </div>
      </div>
      <div class="indice" style="display:none;">
        {% if joueur_id == 1 %}
            <p>1686 + Taille de la tour Eiffel en m√®tres</p>
        {% elif joueur_id == 2 %}
            <p>Jour : 11 - Nombre d'habitant √† Ath√®nes en million</p>
            <p>Mois : 9 - Nombre d'habitant en million de Paris</p>
        {% elif joueur_id == 3 %}
            <p>Poids de la Tour Eiffel - Altitude du pont Cau Vang - 6 900</p>
        {% endif %}
      </div>
    </div>

<script>
const helpBtn = document.querySelector('.bouton-aide');
const popup = document.getElementById('popup-indice');
const closePopup = document.getElementById('close-popup');
const confirmBtn = document.getElementById('confirm-indice');
const cancelBtn = document.getElementById('cancel-indice');
const indice = document.querySelector('.indice');

const submitBtn = document.getElementById('submit-reponse');
const reponse = document.getElementById('reponse');
const resultat = document.querySelector('.resultat');
const erreur = document.querySelector('.erreur');
const reponseBox = document.querySelector('.reponse-box');
const popupAttaque = document.getElementById('popup-attaque');
const closeAttaque = document.getElementById('close-attaque');

let joueurId = localStorage.getItem('joueurId') || '{{ joueur_id }}';
let questionActuelle = localStorage.getItem('questionActuelle') || 1;
let indiceUtilise = localStorage.getItem('indiceUtilise') === 'true';

const urlMatch = window.location.pathname.match(/question(\d+)\/\d+\//);
if (urlMatch) {
    const currentQuestion = parseInt(urlMatch[1]);
    if (currentQuestion !== parseInt(questionActuelle)) {
        window.location.href = `/question${questionActuelle}/${joueurId}/`;
    }
}

if (indiceUtilise) {
    helpBtn.disabled = true;
    helpBtn.style.opacity = 0.5;
    indice.style.display = 'none';
}

helpBtn.addEventListener('click', () => {
    popup.style.display = 'flex';
});

closePopup.addEventListener('click', () => popup.style.display = 'none');
cancelBtn.addEventListener('click', () => popup.style.display = 'none');

confirmBtn.addEventListener('click', () => {
    indice.style.display = 'block';
    helpBtn.disabled = true;
    helpBtn.style.opacity = 0.5;
    popup.style.display = 'none';
    reponseBox.style.display = 'block';
    localStorage.setItem('indiceUtilise', true);
});

submitBtn.addEventListener('click', () => {
    document.getElementById('format-reponse').style.display = 'none';
    const valeur = reponse.value.trim().toLowerCase();
    if (valeur === 'marina bay sands hotel 08/07 18:00') {
        document.getElementById('enonce').style.display = 'none';
        reponseBox.style.display = 'none';
        erreur.style.display = 'none';
        resultat.style.display = 'none';

        const felicitation = document.getElementById('felicitation');
        const indiceSuivant = document.getElementById('indice-suivant');
        felicitation.style.display = 'block';
        setTimeout(() => {
            felicitation.style.display = 'none';
            indiceSuivant.style.display = 'block';
        }, 2000);
        questionActuelle = parseInt(questionActuelle) + 1;
        localStorage.setItem('questionActuelle', questionActuelle);
        setTimeout(() => {
            popupAttaque.style.display = 'flex';
        }, 5000);
    } else {
        erreur.style.display = 'block';
    }
});

closeAttaque.addEventListener('click', () => {
    popupAttaque.style.display = 'none';
    window.location.href = `/question${questionActuelle}/${joueurId}/`;
});

document.addEventListener('DOMContentLoaded', () => {
    const timerEl = document.getElementById('timer');
    const DUREE = 1 * 10 * 1000;

    // V√©rifie si une fin de timer est d√©j√† stock√©e
    let endTime = localStorage.getItem('timerEnd');
    if (!endTime) {
        endTime = Date.now() + DUREE;
        localStorage.setItem('timerEnd', endTime);
    } else {
        endTime = parseInt(endTime);
    }

    function updateTimer() {
        const now = Date.now();
        let diff = Math.max(0, Math.floor((endTime - now) / 1000)); // en secondes

        const minutes = Math.floor(diff / 60);
        const secondes = diff % 60;
        if (timerEl) {
            timerEl.textContent = `${String(minutes).padStart(2,'0')}:${String(secondes).padStart(2,'0')}`;
        }

        if (diff <= 0) {
            localStorage.removeItem('timerEnd');
            window.location.href = `/fail1/${joueurId}`;
        } else {
            setTimeout(updateTimer, 1000);
        }
    }

    updateTimer();
});

</script>
</body>
</html>